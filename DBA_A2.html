<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="DBA_A2.js"></script>
    <title>Smart Contract Voting</title>
    <link rel="stylesheet" href="DBA_A2.css">
</head>

<body>
    <header>
        <h1>Voting Platform</h1>
        <p><button class="primary" onclick="voting.connectWallet()">Connect</button></p>
    </header>

<main>
    <section aria-labelledby="coordinator">
        <h2 id="coordinator">Coordinator</h2>
        <p class="row">
          <button class="primary" onclick="voting.connectWallet()">Connect Wallet</button>
          <button onclick="voting.myNetwork?.().then(n=>network.textContent=n?.name||'')">Get Network</button>
          <button onclick="voting.myBalanceWei?.().then(b=>balance.textContent=b)">Get My Balance</button>
        </p>
        <p>My address: <span id="address" class="val">—</span></p>
        <p>My balance (wei): <span id="balance" class="val">—</span></p>
        <p>Network: <span id="network" class="val">—</span></p>
    </section>

    <section aria-labelledby="status-h">
        <h2 id="status-h">Status</h2>
        <p class="row">
          <button onclick="voting.getStatus().then(s=>{roundId.textContent=s._roundId;phaseName.textContent=s.phaseName;flagSession.textContent=s._sessionInitialised;flagOpen.textContent=s._electionOpened;flagClosed.textContent=s._electionClosed;})">Refresh</button>
          <button onclick="voting.getTopic().then(x=>statusTopic.textContent=x)">Get Topic</button>
          <button onclick="voting.getOptions().then(xs=>statusOptions.textContent=xs.join(', '))">Get Options</button>
        </p>
        <p>Round: <span id="roundId" class="val">—</span></p>
        <p>Phase: <span id="phaseName" class="val">—</span></p>
        <p>Session initialised: <span id="flagSession" class="val">—</span></p>
        <p>Election opened: <span id="flagOpen" class="val">—</span></p>
        <p>Election closed: <span id="flagClosed" class="val">—</span></p>
        <p>Topic: <span id="statusTopic" class="val">—</span></p>
        <p>Options: <span id="statusOptions" class="val">—</span></p>
    </section>

    <section aria-labelledby="admin-h">
        <h2 id="admin-h">Corrdinator Section</h2>
    
        <fieldset>
          <legend>Topic & Options</legend>
          <label for="topic">Topic</label>
          <input id="topic" placeholder="e.g., Choose the mascot" />
          <label for="optionsCsv">Options</label>
          <textarea id="optionsCsv" placeholder="Dog, Cat, Koala"></textarea>
          <p class="row">
            <button onclick="(async()=>{await voting.initializeSession(topic.value,optionsCsv.value)})()">Initialize Session</button>
            <button onclick="(async()=>{await voting.setTopicAndOptions(topic.value,optionsCsv.value)})()">Set Topic & Options</button>
            <button onclick="(async()=>{await voting.resetSession(topic.value,optionsCsv.value)})()">Reset Session</button>
          </p>
          <p class="row">
            <button onclick="voting.getTopic().then(x=>currentTopic.textContent=x)">Get Topic</button>
            <span id="currentTopic" class="val">—</span>
          </p>
          <p class="row">
            <button onclick="voting.getOptions().then(lst=>{currentOptions.textContent=lst.join(', '); voteSelect.innerHTML=''; lst.forEach((o,i)=>voteSelect.add(new Option(`${i}: ${o}`, i)));})">Get Options</button>
            <span id="currentOptions" class="val">—</span>
          </p>
        </fieldset>

        <fieldset>
            <legend>Select Voting Phase</legend>
            <p class="row">
              <button onclick="voting.startVoting()">Start Voting</button>
              <button onclick="voting.endVoting()">End Voting</button>
              <button onclick="voting.revealResults()">Reveal Results</button>
            </p>
        </fieldset>

        <fieldset>
            <legend>Voting Eligibility</legend>
            <label for="eligAddr">Participant Address</label>
            <input id="eligAddr" placeholder="0x..." />
            <p class="row">
              <button onclick="voting.excludeVoter(eligAddr.value)">Exclude</button>
              <button onclick="voting.reinstateVoter(eligAddr.value)">Reinstate</button>
              <button onclick="voting.getExcluded().then(list=>excludedList.textContent=list.join(', '))">Get Excluded List</button>
            </p>
            <p>Excluded: <span id="excludedList" class="val">—</span></p>
          </fieldset>
    </section>
    
    <section aria-labelledby="participant-h">
        <h2 id="participant-h">Participant Panel</h2>
    
        
        <fieldset>
          <legend>Voting</legend>
          <p class="row">
            <button onclick="voting.getOptions().then(lst=>{voteSelect.innerHTML=''; lst.forEach((o,i)=>voteSelect.add(new Option(`${i}: ${o}`, i)));})">Load Options</button>
            <select id="voteSelect"></select>
            <button onclick="voting.castVote(parseInt(voteSelect.value,10))">Cast Vote</button>
          </p>
          <p class="row">
            <button onclick="voting.viewMyVote().then(v=>myVote.textContent=v.voted?`${v.optionIndex}: ${v.optionText}`:'Not voted')">View My Vote</button>
            <span id="myVote" class="val">—</span>
          </p>
        </fieldset>
   
    <section aria-labelledby="results-h">
        <h2 id="results-h">Results</h2>
          
        <p id="resultsLockMsg" class="row">
            Results are hidden until the coordinator reveals them after voting ends.
        </p>
          
        <p class="row">
            <button id="btnReveal" onclick="revealAndRefresh()">Reveal Results (Admin)</button>
            <button id="btnGetResults" onclick="fetchAndRenderResults()" disabled>Get Results</button>
        </p>
          
        <p>Winning option(s): <span id="winners" class="val">—</span></p>
            <table id="resultsTable" style="border-collapse:collapse;display:none">
            <thead>
            <tr>
                <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #ccc;">Option</th>
                <th style="text-align:right;padding:6px 8px;border-bottom:1px solid #ccc;">Votes</th>
            </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
            </table>
    </section>

</body>
</html>